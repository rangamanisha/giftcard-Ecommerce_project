#
# @title:  'Gifti Global: CI File'
#
# @author:
# - name: Sai Charan K
#  affiliation: Merit Incentives
#
# @date: 2021-15-04
#
# @tags: [giftiglobal-ui, giftiglobal-server]
#
# @abstract: |
#  There are 2 different stages, (build and deploy) for 2 projects. (React and Python)
#  React project build does an `npm build`. The deploy stage deploys the content of the build folder to S3
#  Python project build does a `docker build`. The deploy stage pushes the image to gitlab container registry.
#
# @version: 1.0
#

deploy:giftiglobal_ui:
  image: node:14
  stage: deploy
  before_script:
    - apt-get update
    - apt-get install -y -qq python3-dev python3-pip
    - pip3 install --upgrade awscli
  cache:
    paths:
      - node_modules/
  script: 
    - export PATH=./node_modules/.bin:$PATH
    - cd client && npm install
    - npm run build
    - aws s3 sync build/ s3://$GIFTI_GLOBAL_OLD_BUCKET_NAME --exclude ".DS_Store/*" --cache-control "max-age=120000" --delete
  only:
    - dev-old
